
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="row">
    <div class="col-sm-8">
        <div class="box box-info">
            <div class="box-body">
                <div class="form-group">
                    <label class="col-sm-2">Name</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control required" id="txtPatientName">
                        <input type="text" class="none" id="txtId" />
                    </div>
                    <label class="col-sm-2">Address</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" id="txtPatientAddress" disabled>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2">AdmissionDate</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" id="txtAdmissionDate" disabled>
                    </div>
                    <label class="col-sm-2">AdmissionTime</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" id="txtAdmissionTime" disabled>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2">Ref. Doctor</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" id="txtRefDr" disabled>
                    </div>
                    <label class="col-sm-2">Total Days</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" id="txtTotalDays" disabled>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2">Bed No</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" id="txtBedNo" disabled>
                        <input type="text" class="none" id="txtBedId">
                    </div>
                    <label class="col-sm-2">Floor No</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" id="txtFloorNo" disabled>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2">Under Dr</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="txtUnderDr" disabled>
                    </div>
                </div>
                
            </div>
        </div>
        <div class="box box-info">
            <div class="box-body">
                <div class="form-group table-scrollable">
                    <table class="table table-striped table-hover table-bordered">
                        <thead>
                            <tr>
                                <th class="text-center">Investigation Name</th>
                                <th class="text-center">Charge</th>
                                <th class="text-center col-sm-1">Qty</th>
                                <th class="text-center">Total</th>
                                <th class="text-center">Vat</th>
                                <th class="text-center">S.C</th>
                                <th class="text-center">G.Total</th>
                                <th class="text-center col-sm-1">Adjust</th>
                                @*/<th class="text-center col-sm-1">Pay</th>/*@
                                
                            </tr>
                        </thead>
                        <tbody class="text-center" id="tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-4">
        <div class="box box-info payment-area">
            <div class="box-body">
                <div class="form-group">
                    <label class="col-sm-6">Total Amount</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control" id="txtTotalAmount" disabled />
                        <input type="text" class="none" id="TotalServiceCharge" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-6">Advance Receive</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control" id="txtAdvanceAmount" value="0" disabled />
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-6">Total Adjust</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control" id="txtLessAmount" value="0" disabled />
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-6">Net Payable</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control" id="txtNetPayable" disabled value="0" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-6">Receive Amount</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control" id="txtReceiveAmount" value="0" disabled />
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-6">Due Amount</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control" id="txtDueAmount" value="0" disabled />
                    </div>
                </div>
                <div class="form-group">
                    <div class="payment-method">
                        <ul class="navigation">
                            <li class="active"><a data-toggle="tab" href="#cash">Cash</a></li>
                            <li><a data-toggle="tab" href="#card">Card</a></li>
                            <li><a data-toggle="tab" href="#Cheque">Cheque</a></li>
                        </ul>
                        <div class="user-body">
                            <div class="tab-content">
                                <div id="cash" class="tab-pane active">
                                    <div class="form-group">
                                        <label class="col-sm-6">Cash Amount</label>
                                        <div class="col-sm-6">
                                            <input type="text" class="form-control required isnumber" id="txtCashAmount" value="0" />
                                        </div>
                                    </div>
                                </div>
                                <div id="card" class="tab-pane">
                                    <div class="form-group">
                                        <label class="col-sm-6">Card Amount</label>
                                        <div class="col-sm-6">
                                            <input type="text" class="form-control defaultZero isnumber" id="txtCardAmount" value="0" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-6">Card Number</label>
                                        <div class="col-sm-6">
                                            <input type="text" class="form-control defaultZero" id="txtCardNumber" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-6">Bank Name</label>
                                        <div class="col-sm-6">
                                            <select class="form-control" id="txtCardBankId">
                                                <option value="0">-- Select --</option>
                                                <option value="1">DBBL</option>
                                                <option value="2">IBBL</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div id="Cheque" class="tab-pane">
                                    <div class="form-group">
                                        <label class="col-sm-6">Cheaque Amount</label>
                                        <div class="col-sm-6">
                                            <input type="text" class="form-control defaultZero isnumber" id="txtCheaqueAmount" value="0" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-6">Cheaque Number</label>
                                        <div class="col-sm-6">
                                            <input type="text" class="form-control defaultZero" id="txtCheaqueNumber" />
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-6">Bank Name</label>
                                        <div class="col-sm-6">
                                            <select class="form-control" id="txtCheaqueBankId">
                                                <option value="0">-- Select --</option>
                                                <option value="1">DBBL</option>
                                                <option value="2">IBBL</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-6">Return Amount</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control" value="0" id="txtReturnAmount" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-6">Patient Status</label>
                    <div class="col-sm-6">
                        <select class="form-control" id="txtPatientStatus">
                            <option value="Improved">Improved</option>
                            <option value="Department Shift">Department Shift</option>
                            <option value="DORB">DORB</option>
                            <option value="Transferred">Transferred</option>
                            <option value="Others">Others</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-6">OT Name</label>
                    <div class="col-sm-6">
                        <select class="form-control" id="txtOTName"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-6">Remarks</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control defaultNA" id="txtRemarks" placeholder="Remarks" />
                    </div>
                </div>
            </div>
        </div>
        <div class="box box-info">
            <div class="box-body">
                <div class="button-group text-center">
                    <input type="submit" class="btn btn-info" id="btnSave" onclick="Save();" value="Save">
                    <input type="submit" class="btn btn-primary" id="btnList" value="View All">
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-12">
        <div class="box box-info">
            <div class="box-body">
                <div class="form-group">
                    <table class="table table-bordered table-striped table-hover datatable">
                        <tbody id="dataget"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        getOtName();
        $(document).on("keyup", "#tbody .less input", calculateGrid);
        $(document).on("keyup", "#tbody .qty input", adjustGrid);
        $('#txtPatientName').autocomplete({
            source: function (request, response) {
                $.ajax({
                    type: "GET",
                    url: apiUrl + "AdmissionApi/GetAdmittedPatientList",
                    dataType: "Json",
                    data: { 'id': 0, 'searchString': $("#txtPatientName").val() },
                    success: function (data) {
                        response(data.slice(0, 10));
                    }
                });
            },
            select: function (event, ui) {
                $("#txtId").val(ui.item.ptIndoorId);
                $("#txtPatientName").val(ui.item.ptName);
                $("#txtPatientAddress").val(ui.item.ptAddress);
                $("#txtAdmissionDate").val(ToJsonDate(ui.item.admissionDate));
                $("#txtAdmissionTime").val(ui.item.admissionTime);
                $("#txtRefDrCode").val(ui.item.refDrId);
                $("#txtRefDr").val(ui.item.refDrName);
                $("#txtUnderDrCode").val(ui.item.underDrId);
                $("#txtUnderDr").val(ui.item.underDrName);
                $("#txtBedNo").val(ui.item.bedNo);
                $("#txtBedId").val(ui.item.bedId);
                $("#txtFloorNo").val(ui.item.floorNo);
                $("#txtChargePerDay").val(ui.item.bedCharge);
                $("#txtTotalDays").val(ui.item.noOfCount);
                $("#txtAdmissionCharge").val(ui.item.admissionCharge);
                $("#txtTotalCharge").val(ui.item.totalAmount);
                clinicalChart(ui.item.ptIndoorId);
                advanceAmount(ui.item.ptIndoorId);
                return false;
            },
            minLength: 3
        }).data("ui-autocomplete")._renderItem = function (ul, item) {
            if (ul.children().length === 0) {
                $("<thead><tr><th>Name</th><th>Mobile</th><th>FatherName</th><th>Address</th></tr></thead>").appendTo(ul)
            }
            var html = "<td>" + item.ptName + "</td>";
            html += "<td>" + item.ptMobileNo + "</td>";
            html += "<td>" + item.ptFatherName + "</td>";
            html += "<td>" + item.ptAddress + "</td>";
            return $("<tr></tr>").append(html).appendTo(ul);
        };
    });
    function clinicalChart(param) {
        $.ajax({
            type: "GET",
            url: apiUrl + "IndoorPatientReleaseApi/GetClinicaldetail",
            dataType: "Json",
            data: { 'indoorId': param },
            success: function (data) {
                $('#tbody').empty();
                $.each(data, function (key, item) {
                    var total = item.quantity * item.charge;
                    var drCode = '', isAdjustAmt = item.isAdjustAmtId;
                    if (item.refDrName == 'N/A') { drCode = ''; } else { drCode = "(" + item.refDrName + ")"; }
                    var html = "";
                    html += "<tr>";
                    html += "<td class='none'>" + item.itemId + "</td>";
                    html += "<td class='text-left'>" + item.description + drCode + "</td>";
                    html += "<td class='charge'>" + item.charge + "</td>";
                    if (isAdjustAmt == 1) {
                        html += '<td  class="qty"><input type="text" value="' + item.quantity + '"/></td>';
                    } else {
                        html += "<td>" + item.quantity + "</td>";
                    }
                    html += "<td class='total'>" + total + "</td>";
                    html += "<td class='vat'>" + item.vat + "</td>";
                    html += "<td class='svrCharge'>" + item.serviceCharge + "</td>";
                    html += "<td class='balamt'>" + item.balAmt + "</td>";
                    html += "<td class='less'><input type='text' value='0'/></td>";
                    html += "<td class='none'>" + item.drId + "</td>";
                    html += "<td class='none sCharge'>" + item.serviceCharge + "</td>";
                    html += "<td class='none vats'>" + item.vat + "</td>";
                    html += "<td class='none charges'>" + item.charge + "</td>";
                    html += "<td class='none quantity'>" + item.quantity + "</td>";
                    html += "<td class='none balamts'>" + item.balAmt + "</td>";
                    html += "</tr>";
                    $('#tbody').append(html);
                    $('#txtTotalAmount').val(sumColumn(8));
                    $('#TotalServiceCharge').val(sumColumn(7));
                });
            },
            error: function (errormessage) { alert(errormessage.responseText); }
        });
    }

    function advanceAmount(param) {
        $.ajax({
            type: "GET",
            url: apiUrl + "IndoorAdvanceCollectionApi/GetTotalAdvanceCollectionByIndoorId",
            dataType: "Json",
            data: { 'indoorId': param },
            success: function (data) {
                $('#txtAdvanceAmount').val(data);
                advance = parseFloat($('#txtAdvanceAmount').val());
                $('#txtNetPayable').val($('#txtTotalAmount').val() - advance);
            },
            error: function (errormessage) { alert(errormessage.responseText); }
        });
    }

    function calculateGrid() {
        var subtotal = 0;
        $(".less input").each(function () {
            if (!isNaN(this.value) && this.value.length != 0) {
                grandtotal = parseFloat($(this).closest("tr").find('.balamt').text());
                total = parseFloat(this.value);
                if (this.value > grandtotal) {
                    this.value = 0;
                }
                subtotal += parseFloat(total);
            }
        });
        total = $('#txtTotalAmount').val();
        advance = $('#txtAdvanceAmount').val();
        $('#txtLessAmount').val(subtotal);
        $('#txtNetPayable').val(total - subtotal - advance);
    }

    function adjustGrid() {
        var subtotal = 0, subtotals = 0;
        $(".qty input").each(function () {
            if (!isNaN(this.value) && this.value.length != 0) {
                charge = parseFloat($(this).closest("tr").find('.charges').text());
                vats = $(this).closest("tr").find('.vats').text();
                scharge = $(this).closest("tr").find('.sCharge').text();
                quantity = $(this).closest("tr").find('.quantity').text();
                balamts = $(this).closest("tr").find('.balamts').text();

                totalcharge = parseFloat(this.value) * charge;
                vat = (vats / quantity) * parseFloat(this.value);
                svrCharge = (scharge / quantity) * parseFloat(this.value);

                parseFloat($(this).closest("tr").find('.vat').text(vat));
                parseFloat($(this).closest("tr").find('.svrCharge').text(svrCharge));
                parseFloat($(this).closest("tr").find('.total').text(totalcharge));
                total = svrCharge + vat + totalcharge;
                adjust = balamts - (((vats / quantity) + (scharge / quantity) + charge) * this.value);
                $(this).closest("tr").find('.balamt').text(total);
                $(this).closest("tr").find('.less input').val(adjust);
                subtotals += parseFloat(total);
                subtotal += parseFloat(adjust);
            }
        });
        $('#txtTotalAmount').val(sumColumn(8));
        total = $('#txtTotalAmount').val();
        advance = $('#txtAdvanceAmount').val();
        $('#txtLessAmount').val(subtotal);
        $('#txtNetPayable').val(total - subtotal - advance);
    }
    $("#txtCashAmount, #txtCardAmount, #txtCheaqueAmount").keyup(function () {
        var cash = parseFloat($("#txtCashAmount").val());
        var card = parseFloat($("#txtCardAmount").val());
        var cheque = parseFloat($("#txtCheaqueAmount").val());
        var totalPay = parseFloat($("#txtNetPayable").val());

        $("#txtDueAmount").val(totalPay - parseFloat(cash + card + cheque));
        $("#txtReceiveAmount").val(parseFloat(cash + card + cheque));
        if ($("#txtDueAmount").val() < 0) {
            $("#txtReceiveAmount").val(0);
            $("#txtCashAmount").val(0);
            $("#txtCardAmount").val(0);
            $("#txtCheaqueAmount").val(0);
            $("#txtDueAmount").val($("#txtNetPayable").val());
        }
    });

    function getOtName() {
        $.ajax({
            type: "GET",
            url: apiUrl + "IndoorPatientReleaseApi/GetOperationName",
            dataType: "Json",
            success: function (data) {
                $('#txtOTName').html($("<option></option>").attr("value", 0).text("-- Select --"));
                $.each(data, function (key, item) {
                    var rows = "<option value='" + item.id + "'>" + item.name + "</option>";
                    $('#txtOTName').append(rows);
                });
            },
            error: function (errormessage) { alert(errormessage.responseText); }
        });
    }

    function Save() {
        var res = validation();
        var custom = customvalid();
        if (res & custom == true) {
            var vouchers = [];
            var table = $('table #tbody');
            table.find('tr').each(function () {
                var $tds = $(this).find('td'),
                    tItemId = $tds.eq(0).text(),
                    tCharge = $tds.eq(2).text(),
                    tQuantity = $tds.eq(3).find('input').val() | $tds.eq(3).text(),
                    // $tds.eq(4).find('input').val() | $tds.eq(4).text(),
                    tTotalCharge = $tds.eq(4).text(),
                    tVat = $tds.eq(5).text(),
                    tServiceCharge = $tds.eq(6).text(),
                    tItemTotal = $tds.eq(7).text(),
                    tItemwiseLess = $tds.eq(8).find('input').val(),
                    tdrId = $tds.eq(9).text();
                    //tMaxrefFee = $tds.eq(10).find('input').val();

                var voucher = {
                    PtIndoorId: $('#txtId').val(),
                    TotalDays: $('#txtTotalDays').val(),
                    AdvanceAmt: $('#txtAdvanceAmount').val(),
                    TotalAmount: $('#txtTotalAmount').val(),
                    TotalServiceCharge: $('#TotalServiceCharge').val(),
                    LessAmount: $('#txtLessAmount').val(),
                    CollAmt: $('#txtReceiveAmount').val(),
                    ReturnAmount: $('#txtReturnAmount').val(),
                    BedId: $('#txtBedId').val(),
                    PatientStatus: $('#txtPatientStatus').val(),
                    CashAmount: $("#txtCashAmount").val(),
                    CardAmount: $("#txtCardAmount").val(),
                    CheaqueAmount: $("#txtCheaqueAmount").val(),
                    CardNumber: $("#txtCardNumber").val(),
                    CardBankId: $("#txtCardBankId").val(),
                    CheaqueNumber: $("#txtCheaqueNumber").val(),
                    CheaqueBankId: $("#txtCheaqueBankId").val(),
                    ItemId: tItemId,
                    Charge: tCharge,
                    Quantity: tQuantity,
                    TotalCharge: tTotalCharge,
                    Vat: tVat,
                    ServiceCharge: tServiceCharge,
                    ItemwiseLess: tItemwiseLess,
                    ItemTotal: tItemTotal,
                  //  MaxRefFee: tMaxrefFee,
                    DrId: tdrId,
                    Remarks: $('#txtRemarks').val(),
                    UserName: "@System.Web.HttpContext.Current.Session["UserName"]",
                };
                vouchers.push(voucher);
            });
            $.ajax({
                type: "Post",
                url: apiUrl + "IndoorPatientReleaseApi/Post",
                contentType: "application/json; charset=utf-8",
                dataType: "Json",
                data: JSON.stringify(vouchers),
                success: function (data) {
                    if (data.output != "error") {
                        alert(data);
                        location.reload(true);
                    } else {
                        alert(data);
                    }
                },
                error: function (errormessage) {
                    alert(errormessage.responseText);
                }
            });
            return false;
        }
        else {
                alert("Please fill required field");
        }
    return false;
    }

    $('#btnList').on('click', function () {
        $(".list-area").fadeToggle(500);
        LoadDataTable();
    });
    function LoadDataTable() {
        $(".datatable").DataTable({
            destroy: true,
            "ajax": {
                url: apiUrl + "IndoorPatientReleaseApi/GetIndoorPatientReleaseList",
                dataSrc: "",
            },
            "columns": [
                    { "data": "releaseId", "title": "ReleaseId", visible: false },
                    { "data": "patientId", "title": "PatientId", visible: false },
                    { "data": "releaseDate","title": "Release Date", "render": function (data) { return (ToJsonDate(data)); } },
                    { "data": "bedNo", "title": "Bed No" },
                    { "data": "ptName", "title": "Name" },
                    { "data": "ptMobileNo", "title": "MobileNo" },
                    { "data": "ptAddress", "title": "Address" },
                    { "data": "totalAmount", "title": "TotalAmount" },
                    {
                        "data": "releaseId", width: "80px", "title": "Action",
                        "render": function (data) {
                            return "<a href='javascript:;' class='md-trigger' onclick='return GetReprintPatientRelease(" + data + ")'><span class='glyphicon glyphicon-edit'></span></a>";
                        }
                    }
                ]

        });
    }

    function GetReprintPatientRelease(param) {
        $.ajax({
            type: "GET",
            url: apiUrl + "IndoorPatientReleaseApi/GetReprintIndoorPatientRelease",
            dataType: "Json",
            data: { 'releaseId': param },
            success: function (data) {
                    window.open("/Report/ReportViewer/ReportViewer.aspx", "directories=no,height=100,width=100");
            },
            error: function (errormessage) { alert(errormessage.responseText); }
        });
    }

    function customvalid() {
        var isValid = true;

        if ($("#txtCashAmount").val() != 0 || $("#txtCardAmount").val() != 0 || $("#txtCheaqueAmount").val() != 0) {
            isValid = true;
        }
        if ($("#txtCardAmount").val() > 0) {
            if ($("#txtCardNumber").val() && $("#txtCardBankId").val() == 0) {
                alert("Please add Card Number or Bank Name");
                $(".navigation li:nth-child(2), .tab-content .tab-pane:nth-child(2)").addClass("active").trigger("change");
                $(".navigation li:first-child, .tab-content .tab-pane:first-child").removeClass("active");
                $(".navigation li:last-child, .tab-content .tab-pane:last-child").removeClass("active");
                isValid = false;
            }
        }

        if ($("#txtCheaqueAmount").val() > 0) {
            if ($("#txtCheaqueNumber").val() && $("#txtCheaqueBankId").val() == 0) {
                alert("Please add Cheaque Number or Bank Name");
                $(".navigation li:last-child, .tab-content .tab-pane:last-child").addClass("active").trigger("change");
                $(".navigation li:first-child, .tab-content .tab-pane:first-child").removeClass("active");
                $(".navigation li:nth-child(2), .tab-content .tab-pane:nth-child(2)").removeClass("active");
                isValid = false;
            }
        }
        return isValid;
    }
</script>