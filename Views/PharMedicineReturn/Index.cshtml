
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-sm-12">
        <div class="box box-info">
            <div class="box-header">Patient Info 18120010</div>
            <div class="box-body">
                <div class="form-group">
                    <label class="col-sm-2">Reg No</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" id="txtRegistrationNo" onchange="GetPurchaseInvNo()" />
                        <input type="text" class="none" id="txtId" />
                    </div>
                    <label class="col-sm-2">Indoor ID</label>
                    <div class="col-sm-4">
                        <select class="form-control select2" id="txtIndoorPatientID">
                            <option value="0">--Select--</option>
                            <option value="1">Patient Id</option>
                            <option value="2">Patient Id 2</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2">Name</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control required" id="txtPatientName" disabled>
                    </div>
                    <label class="col-sm-2">Mobile</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control required" id="txtMobileNo" disabled>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2">Age</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control required" id="txtPatientAge" disabled>
                    </div>
                    <label class="col-sm-2">Gender</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control required" id="txtPatientGender" disabled>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2">Address</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="txtPatientAddress" disabled>
                    </div>
                </div>

                <div class="div-display">
                    <div class="form-group">
                        <label class="col-sm-2">Patient</label>
                        <div class="col-sm-4">
                            <input type="text" class="none" id="txtId">
                            <input type="text" class="form-control" id="txtNameOfPatient">
                        </div>
                        <label class="col-sm-2">Addmission</label>
                        <div class="col-sm-4">
                            <input type="text" class="form-control" id="txtAddmissionDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2">Address </label>
                        <div class="col-sm-4">
                            <input type="text" class="form-control" id="txtAddress">
                        </div>
                        <label class="col-sm-2">Bed No</label>
                        <div class="col-sm-4">
                            <input type="text" class="form-control" id="txtBedNo">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="table-scrollable">
                        <table class="table table-striped table-hover table-bordered">
                            <thead>
                                <tr>
                                    <th class="col-sm-4">Product Name</th>
                                    <th class="col-sm-2">Invoice Date</th>
                                    <th class="col-sm-1">Invoice No</th>
                                    <th class="col-sm-1">MRP</th>
                                    <th class="col-sm-1">Rtn Qty</th>
                                    <th class="col-sm-1"> Amt</th>
                                    <th class="col-sm-1">Action</th>
                                </tr>
                            </thead>
                            <tbody class="text-center" id="tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="box box-info">
            <div class="box-header">Payment Info</div>
            <div class="box-body">
                <div class="form-group">
                    <label class="col-sm-2">Total Amount</label>
                    <div class="col-sm-2">
                        <input type="text" class="form-control" id="txtTotalAmount" disabled />
                    </div>
                    <label class="col-sm-2">Total Item Less</label>
                    <div class="col-sm-2">
                        <input type="text" class="form-control" id="txtTotalItemLess" disabled />
                    </div>
                    <label class="col-sm-2">Net Rtn  </label>
                    <div class="col-sm-2">
                        <input type="text" class="form-control" id="txtNetRtn" disabled />
                    </div>
                </div>
                
                
                <div class="form-group">
                    <label class="col-sm-2">Due Amount</label>
                    <div class="col-sm-2">
                        <input type="text" class="form-control" id="txtDueAmount" disabled />
                    </div>
                    <label class="col-sm-2">Received Amt</label>
                    <div class="col-sm-2">
                        <input type="text" class="form-control" id="txtReceivedAmtSale" disabled />
                    </div>
                    <label class="col-sm-2">Total Amt </label>
                    <div class="col-sm-2">
                        <input type="text" class="form-control" id="txtTotalSaleAmt" disabled />
                    </div>
                </div>
                

                <div class="form-group">
                    <label class="col-sm-2">Return Amt</label>
                    <div class="col-sm-2">
                        <input type="text" class="form-control" id="txtRtnAmt" disabled />
                    </div>
                    <label class="col-sm-2">Cash Rtn </label>
                    <div class="col-sm-2">
                        <input type="text" class="form-control" id="txtCashRtn" disabled /> 
                    </div>
                 
                </div>
                

                <div class="form-group">
                    <label class="col-sm-2">Remarks</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control defaultNA" id="txtRemarks" />
                    </div>
                </div>
                <div class="button-group text-center">
                    <input type="submit" class="btn btn-sm btn-success" id="btnSave" onclick="Save();" value="Save">
                    <input type="submit" class="btn btn-sm btn-primary" id="btnList" value="View All">
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-12">
        <div class="box box-info">
            <div class="box-body">
                <div class="form-group">
                    <table class="table table-bordered table-striped table-hover datatable">
                        <tbody id="dataget"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    $(document).ready(function () {
        $(document).on("keyup", "#tbody .qty", calculateGrid);
        $(document).on("keyup", "#tbody .qty", calculateRtnAmt);
    });



    function GetPurchaseInvNo() {
        $('#tbody').empty();
        $.ajax({
            type: "GET",
            url: '@UrlConfig.Action("GetPharProductList", "PharMedicineReturnApi")',
            dataType: "Json",
            data: { 'param': $("#txtRegistrationNo").val(), 'userName': "@System.Web.HttpContext.Current.Session["UserName"]", },
            success: function (data) {
            //    alert(JSON.stringify(data));
                $.each(data, function (key, item) {
                 $("#txtDueAmount").val(item.dueAmt);
                $("#txtReceivedAmtSale").val(item.advanceAmt);
                $("#txtTotalSaleAmt").val(item.totalAmt);

                    var mrpAmt = parseFloat(item.quantity * item.salesPrice);
                    var lessPer = parseFloat((item.lessAmt * 100) / item.totalAmt);
                    var grandTotal = (mrpAmt) - lessPer * mrpAmt * 0.01;
                    var itemTotalLess = item.itemLessTk * item.balQty;
                    var rows = "<tr id=" + item.id + ">"
                        + "<td>" + item.name + "</td>"
                        + "<td>" + ToJsonDate(item.invoiceDate) + "</td>"
                        + "<td>" + item.invoiceNo + "</td>"
                        + "<td class='none'>" + item.quantity + "</td>"
                        + "<td class='mrp'>" + item.salesPrice + "</td>"
                        + "<td><input type='text' class='form-control qty'value=" + item.balQty + " id='rtnqty'></td>"
                        + "<td class='mrpamt'>" + grandTotal + "</td>"
                        + "<td><a href='javascript:;' class='deleteRow'><span class='glyphicon glyphicon-trash'></span></a></td>"
                        + "<td class='none'>" + item.invMasterId + "</td>"
                        + "<td class='none'>" + item.companyId + "</td>"
                        + "<td class='none'>" + item.itemId + "</td>"
                        + "<td class='none'>" + item.avgPurchasePrice + "</td>"
                        + "<td class='none'>" + item.regId + "</td>"
                        + "<td class='none'>" + item.indoorId + "</td>"
                        + "<td class='none'>" + item.companyId + "</td>"  
                        + "<td class='none'>" + item.lessPc + "</td>"
                        + "<td class='none'>" + item.lessPcOrTk + "</td>"
                        + "<td class='none'>" + item.lessAmt + "</td>"
                        + "<td class='none'>" + item.subSubPnoId + "</td>"
                        + "<td class='none'>" + item.corporateId + "</td>"
                        + "<td class='none'>" + item.barCodeId + "</td>"
                        + "<td class='none lessPer'>" + lessPer + "</td>"
                        + "<td class='none balQty'>" + item.balQty + "</td>"
                        + "<td class='none mainDeptId'>" + item.mainDeptId + "</td>"
                        + "<td class='none txtTotalLess'>" + itemTotalLess + "</td>"
                        + "<td class='none txtItemLess'>" + item.itemLessTk + "</td>"
                        + "</tr>";
                    $('#tbody').append(rows);
                    calculateGrid();
                    calculateRtnAmt();
                    $("#txtTotalAmount").val(sumColumn(7));
                    $("#txtTotalItemLess").val(sumColumn(25));
                });
            },
            error: function (errormessage) { alert(errormessage.responseText); }
        });
    }
    

    function calculateRtnAmt() {
        var dueAmt = $("#txtDueAmount").val();
        var advanceAmt = $("#txtReceivedAmtSale").val();
        var totalAmt = $("#txtTotalSaleAmt").val();
        var totalrtn=$("#txtTotalAmount").val();
        var lessRtn=$("#txtTotalItemLess").val();
        var netRtn = totalrtn - lessRtn;
        $("#txtNetRtn").val(netRtn);

        if (dueAmt==0) {
            $("#txtRtnAmt").val(0);
            $("#txtCashRtn").val(netRtn);
        }else {
             if (netRtn >= dueAmt) {
                 $("#txtRtnAmt").val(dueAmt);
                 $("#txtCashRtn").val(netRtn - dueAmt);
            }
            else {
                 $("#txtRtnAmt").val(netRtn);
                 $("#txtCashRtn").val(0);
             }
        }
    }

    $('#btnList').on('click', function () {
        $(".list-area").fadeToggle(500);
        LoadDataTable();
    });

    function LoadDataTable() {
        $(".datatable").DataTable({
            destroy: true,
            "order": [[ 1, "desc" ]] ,
            "ajax": {
               
                url: apiUrl + "PharMedicineReturnApi/GetInvoiceList?userName=" +@System.Web.HttpContext.Current.Session["UserName"] +"",
                dataSrc: ""
            },
            "columns": [
                { "data": "invoiceNo", "title": "InvoiceNo" },
                { "data": "invoiceDate", "name": "InvoiceDate", "render": function (data) { return (window.ToJsonDate(data)); } },
                { "data": "customerName", "title": "Name " },
                    { "data": "totalPrice", "title": "Total Price " },
                {"data": "invoiceNo", width: "80px", "title": "Action",
                    "render": function (data) {
                        return "<a href='javascript:;' class='md-trigger' onclick='return GetReprintByInvoice(\"" + data + "\")'><span class='glyphicon glyphicon-edit'></span></a>";
                    }
                }
            ]
        });
    }

    function GetReprintByInvoice(param) {
        $.ajax({
            type: "GET",
            url: apiUrl + "PharMedicineReturnApi/GetReprintInvoice",
            dataType: "Json",
            data: { 'refNo': param },
            success: function (data) {
                var popupWindow = window.open("/Report/ReportViewer/ReportViewer.aspx", "directories=no,height=100,width=100");
                $(document).ready(function (e) {
                    detectPopup();
                    function detectPopup() {
                        if (!popupWindow) {
                            alert("Popups blocked!!! Please Enable from Your Browser Setting Ex: Chrome->Advanced Settings->Content Settings->Popups' ");
                            return false;
                        } else {
                            window.open('', '_self');
                            window.close();
                        }
                    }
                });
            }
        });
    }
    
    function calculateGrid() {
        var subtotal = 0;
        var subtotalLess = 0;
        $(".qty").each(function () {
            if (!isNaN(this.value) && this.value.length != 0) {
                var lessPerc = parseFloat($(this).closest("tr").find('.lessPer').text());
                var total = parseFloat(this.value) * parseFloat($(this).closest("tr").find('.mrp').text());
                var grandTotal = ((total) - lessPerc * total * 0.01).toFixed(6);
                $(this).closest("tr").find('.mrpamt').text(grandTotal);
                var balQty = parseFloat($(this).closest("tr").find('.balQty').text());
                var itemLess = parseFloat($(this).closest("tr").find('.txtItemLess').text());
                var lessTotal = (parseFloat(this.value) * itemLess).toFixed(6);
                $(this).closest("tr").find('.txtTotalLess').text(lessTotal);
                //alert(lessPerc);
                if (parseFloat(this.value) > balQty) {
                    parseFloat(this.value = 0);
                }
                subtotal += parseFloat(grandTotal);
                subtotalLess += parseFloat(lessTotal);
            }
        });
        $("#txtTotalAmount").val(subtotal);
        $("#txtTotalItemLess").val(subtotalLess);
    }

    $("table #tbody").on("click", "a.deleteRow", function (event) {
        event.preventDefault();
        $(this).closest('tr').remove();
        $(function () {
            $("#txtTotalAmount").val(sumColumn(7));
        });
        return false;
    });

    function Save() {
            var vouchers = [];
            var table = $('table #tbody');
            table.find('tr').each(function () {
                var $tds = $(this).find('td'),
                //  tId = $tds.eq(0).text(),
                    tName = $tds.eq(0).text(),
                    tInvoiceDate = $tds.eq(1).text(),
                    tInvNo = $tds.eq(2).text(),
                    tSalesPrice = $tds.eq(4).text(),
                    tRtnQty = $tds.eq(5).find("input").val(),
                    tInvMasterId = $tds.eq(8).text(),
                    tCompanyId = $tds.eq(14).text(),
                    tAvgPurchasePrice = $tds.eq(11).text(),
                    tRegId = $tds.eq(12).text(),
                    tIndoorId = $tds.eq(13).text(),   
                    tLessPc = $tds.eq(15).text(),
                    tLessPcOrTk = $tds.eq(16).text(),
                    tLessAmt = $tds.eq(17).text(),
                    tSubSubPnoId=$tds.eq(18).text(),
                    tCorporateId = $tds.eq(19).text(),
                    tBarCodeId = $tds.eq(20).text(),
                    tMainDeptId = $tds.eq(21).text(),
                    tItemId = $tds.eq(10).text();
                  
                var voucher = {
                  //Id: tId,
                   Name: tName,
                   ItemId: tItemId,
                   CompanyId: tCompanyId,
                   Quantity: tRtnQty,
                   InvMasterId: tInvMasterId,
                   InvoiceNo:tInvNo,
                   AvgPurchasePrice: tAvgPurchasePrice,
                   SalesPrice: tSalesPrice,
                   InvoiceDate: tInvoiceDate,
                   RegId: tRegId,
                   IndoorId: tIndoorId,
                   LessPc:tLessPc,
                   LessPcOrTk: tLessPcOrTk,
                   LessAmt: tLessAmt,
                   SubSubPnoId:tSubSubPnoId,
                   CorporateId: tCorporateId,
                   BarCodeId: tBarCodeId,
                   MainDeptId: tMainDeptId,
                   RtnInvNo: $("#txtRegistrationNo").val(),
                   TotalAmt: $("#txtTotalAmount").val(),
                   Remarks: $("#txtRemarks").val(),
                   CashRtn: $("#txtCashRtn").val(),
                   RtnAmt: $("#txtRtnAmt").val(),
                 //LessPcOrTk: $("#txtLessTkOrPc").val(),
                 //TotalLess: $("#txtTotalLessAmount").val(),
                    UserName: "@System.Web.HttpContext.Current.Session["UserName"]",
                };
            vouchers.push(voucher);
        });
      //  alert(JSON.stringify(vouchers));
       //return false;
        var json = { aModels: vouchers };
        $.ajax({
            type: "POST",
            url: '@UrlConfig.Action("Save", "PharMedicineReturnApi")',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(vouchers),
            success: function (data) {
                if (data.output != "error") {
                    alert(data.msg);
                    window.open("/Report/ReportViewer/ReportViewer.aspx", "_blank");
                    location.reload(true);
                } else {
                    alert(data.msg);
                }
            }
        });
    }
</script>